<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Foorumi Demo (Korjattu)</title>
<style>
  body{font-family:system-ui,Arial;margin:40px auto;max-width:700px;padding:0 16px;background-color:#f4f4f9;}
  input,textarea,button{width:100%;padding:10px;margin-top:8px;box-sizing:border-box;border:1px solid #ccc;border-radius:4px;}
  button{background-color:#007BFF;color:white;border:none;cursor:pointer;font-weight:bold;}
  button:hover{background-color:#0056b3;}
  .post{border:1px solid #ddd;border-radius:8px;padding:15px;margin-top:15px;background:#fff;}
  #msg{color:red;font-weight:bold;margin-top:10px;}
  #debugInfo {
      font-family: monospace; 
      font-size: 12px; 
      color: #555; 
      background: #eee; 
      padding: 10px; 
      margin-top: 10px; 
      border: 1px solid #999;
      display: none; /* Piilotetaan oletuksena */
      word-break: break-all;
  }
</style>
</head>
<body>

<div id="login">
  <h2>Kirjaudu sisään</h2>
  <form id="loginForm" autocomplete="off">
    <input id="user" placeholder="Käyttäjätunnus (xX_adm991)">
    <input id="pass" type="password" placeholder="Salasana (Rv4p!tL9)">
    <button type="button" id="btnLogin">Kirjaudu</button>
  </form>
  <p id="msg"></p>
  
  <div id="debugInfo"></div>
</div>

<div id="forum" style="display:none">
  <h2>Yksityinen foorumi</h2>
  <textarea id="postText" placeholder="Kirjoita viesti..."></textarea>
  <input id="fileInput" type="file" accept="image/*">
  <button id="btnPost">Lähetä</button>
  <div id="posts"></div>
</div>

<script>
const ALLOWED_USER = "xX_adm991";
// Tässä on hash salasanalle "Rv4p!tL9"
const PASS_HASH = "3c1e94cf4f39b5c60c69cf6d5a93d4041b6f82bba36ee2db6ab86916f2f31bb2";

const loginDiv = document.getElementById("login");
const forumDiv = document.getElementById("forum");
const msg = document.getElementById("msg");
const debugInfo = document.getElementById("debugInfo");
const postsDiv = document.getElementById("posts");

// Hash-funktio
async function hashInput(str) {
  try {
    const buf = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
  } catch (e) {
    console.error(e);
    throw new Error("Salaus epäonnistui. Selaimesi saattaa estää crypto.subtle-toiminnon file://-tilassa.");
  }
}

document.getElementById("btnLogin").onclick = async ()=>{
  msg.textContent = "Tarkistetaan...";
  debugInfo.style.display = "none"; // Piilota vanha debug-tieto
  
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value; // Älä trimmaa salasanaa, välilyönnit merkitsevät!

  try {
    const calculatedHash = await hashInput(p);
    
    // LOGIIKKA: Verrataan käyttäjätunnusta ja laskettua hashia
    if(u === ALLOWED_USER && calculatedHash === PASS_HASH){
      loginDiv.style.display="none";
      forumDiv.style.display="block";
      loadPosts();
    } else {
      msg.textContent = "Väärä tunnus tai salasana.";
      
      // NÄYTÄ DEBUG-TIEDOT KÄYTTÄJÄLLE
      debugInfo.style.display = "block";
      debugInfo.innerHTML = `
        <strong>DEBUG-TIEDOT (Kopioi hash koodiin jos se on eri):</strong><br>
        Syötetty tunnus: "${u}"<br>
        Odotettu tunnus: "${ALLOWED_USER}"<br>
        <br>
        Laskettu hash: <b>${calculatedHash}</b><br>
        Odotettu hash: ${PASS_HASH}
      `;
    }
  } catch (error) {
    msg.textContent = "VIRHE: " + error.message;
    alert("Tämä sivu ei toimi suoraan tiedostona (file://) Chromessa/Edgessä tietoturvasyistä.\n\nKokeile Firefoxia tai asenna VS Code 'Live Server' -laajennus.");
  }
};

// Viestien lähetys ja lataus (sama kuin aiemmin)
document.getElementById("btnPost").onclick = ()=>{
  const text = document.getElementById("postText").value.trim();
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];
  if(!text && !file){ alert("Tyhjä viesti!"); return; }

  const post = {text, time: Date.now()};
  if(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      if(e.target.result.startsWith("data:image/")){
          post.image = e.target.result;
          savePost(post);
      }
    };
    reader.readAsDataURL(file);
  }else{
    savePost(post);
  }
};

function savePost(p){
  const posts = JSON.parse(localStorage.getItem("posts")||"[]");
  posts.unshift(p);
  localStorage.setItem("posts", JSON.stringify(posts));
  document.getElementById("postText").value="";
  document.getElementById("fileInput").value="";
  loadPosts();
}

function loadPosts(){
  const posts = JSON.parse(localStorage.getItem("posts")||"[]");
  postsDiv.innerHTML = "";
  for(const p of posts){
    const el = document.createElement("div");
    el.className = "post";
    const t = document.createElement("div"); t.style.fontWeight="bold"; t.textContent = new Date(p.time).toLocaleString();
    const c = document.createElement("div"); c.textContent = p.text || "";
    el.appendChild(t); el.appendChild(c);
    if(p.image){
      const img = document.createElement("img"); img.src = p.image;
      el.appendChild(img);
    }
    postsDiv.appendChild(el);
  }
}
</script>

</body>
</html>
