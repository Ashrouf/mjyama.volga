<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Foorumi Demo</title>
<style>
body{font-family:system-ui,Arial;margin:40px auto;max-width:700px;padding:0 16px}
input,textarea,button{width:100%;padding:8px;margin-top:8px;box-sizing:border-box}
.post{border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px;background:#fafafa}
img{max-width:100%;margin-top:6px}
</style>
</head>
<body>

<div id="login">
  <h2>Kirjaudu sisään</h2>
  <input id="user" placeholder="Käyttäjätunnus">
  <input id="pass" type="password" placeholder="Salasana">
  <button id="btnLogin">Kirjaudu</button>
  <p id="msg"></p>
</div>

<div id="forum" style="display:none">
  <h2>Yksityinen foorumi</h2>
  <textarea id="postText" placeholder="Kirjoita viesti..."></textarea>
  <input id="fileInput" type="file" accept="image/*">
  <button id="btnPost">Lähetä</button>
  <div id="posts"></div>
</div>

<script>
// HUOM: Vaikka salasana on nyt hajautettu (hash), se on silti kovakoodattu
// etupäähän (frontend) ja vain hiekkalaatikkomainen (sandbox) parannus.
const ALLOWED_USER = "xX_adm991";
// SHA-256 -tarkiste salasanalle "Rv4p!tL9"
const PASS_HASH = "3c1e94cf4f39b5c60c69cf6d5a93d4041b6f82bba36ee2db6ab86916f2f31bb2";

const loginDiv = document.getElementById("login");
const forumDiv = document.getElementById("forum");
const msg = document.getElementById("msg");
const postsDiv = document.getElementById("posts");

/**
 * Laskee SHA-256 -hajautuksen annetusta merkkijonosta.
 * @param {string} str Hajautettava merkkijono (salasana).
 * @returns {Promise<string>} Hajautus merkkijonona.
 */
async function hashInput(str) {
  const buf = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest("SHA-256", buf);
  // Muunnetaan ArrayBuffer heksadesimaalimerkkijonoksi
  return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

document.getElementById("btnLogin").onclick = async ()=>{
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;

  // Tarkistetaan tunnus ja syötetyn salasanan hajautus
  if(u===ALLOWED_USER && await hashInput(p)===PASS_HASH){
    loginDiv.style.display="none";
    forumDiv.style.display="block";
    loadPosts();
  } else {
    msg.textContent="Väärä tunnus tai salasana";
  }
};

document.getElementById("btnPost").onclick = ()=>{
  const text = document.getElementById("postText").value.trim();
  const file = document.getElementById("fileInput").files[0];
  if(!text && !file){alert("Kirjoita teksti tai lisää kuva.");return;}

  const post = {text, time: Date.now()};
  if(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      post.image = e.target.result;
      savePost(post);
    };
    reader.readAsDataURL(file);
  }else{
    savePost(post);
  }
};

function savePost(p){
  const posts = JSON.parse(localStorage.getItem("posts")||"[]");
  posts.unshift(p);
  localStorage.setItem("posts", JSON.stringify(posts));
  document.getElementById("postText").value="";
  document.getElementById("fileInput").value="";
  loadPosts();
}

function loadPosts(){
  const posts = JSON.parse(localStorage.getItem("posts")||"[]");
  postsDiv.innerHTML = "";
  for(const p of posts){
    const el = document.createElement("div");
    el.className = "post";
    el.innerHTML = `<div><b>${new Date(p.time).toLocaleString()}</b></div>
                    <div>${p.text||""}</div>
                    ${p.image ? `<img src="${p.image}">` : ""}`;
    postsDiv.appendChild(el);
  }
}
</script>

</body>
</html>
